# Spore Agent Reference

*Last updated: 2026-02-21*

3 pipeline agents + 1 auxiliary role. Each has specific permissions, models, and tool access. Agents with native Claude Code files in `.claude/agents/` get memory and skills injection automatically. Others use inline templates.

## Agent Resolution

`resolve_agent_name(role)` in `spore.rs` checks if `.claude/agents/<role>.md` exists:

- **Found:** Passes `--agent <role>` to Claude Code. Agent gets persistent memory (`memory: project`) and skills injection (`skills: [mycelica-conventions]`).
- **Not found:** Falls back to prepending the inline template from `docs/spore/agents/<role>.md` to the prompt.

This enables portability: foreign repos without `.claude/agents/` files get inline prompts automatically.

**Source:** `resolve_agent_name()` in `src-tauri/src/bin/cli/spore.rs`

## Agent Summary

| Role | Model | Turns | Pipeline | Native File | Inline Template |
|------|-------|-------|----------|-------------|-----------------|
| Coder | opus | 50 | yes | `.claude/agents/coder.md` | `docs/spore/agents/coder.md` |
| Verifier | opus | 50 | yes | `.claude/agents/verifier.md` | `docs/spore/agents/verifier.md` |
| Summarizer | sonnet | 15 | optional | `.claude/agents/summarizer.md` | `docs/spore/agents/summarizer.md` |
| Operator | opus | 80 | no | (none) | `docs/spore/agents/operator.md` |

**Model selection:** `select_model_for_role()` in `spore.rs`. Hardcoded per role. The `complexity` parameter exists in the signature but is unused.

---

## Coder

**Role:** Implements code changes. Reads task file with graph context, writes/edits source files, runs builds.

**Model:** opus (A/B validated: 39% cheaper than sonnet due to fewer turns)

**Permissions:**
- `allowedTools`: `Read,Write,Edit,Bash(*),mcp__mycelica__*`
- `disallowedTools`: `Grep,Glob`

Grep/Glob are intentionally blocked. The coder uses `mycelica_search` and `mycelica_explore` via MCP instead, forcing graph-based exploration over raw file search.

**MCP Access:**
- Read tools: all 16
- Write tools: `mycelica_create_edge`, `mycelica_create_node`

**Inputs:** Task file generated by `generate_task_file()` containing graph context with relevant code node IDs, anchors, and lessons from past runs.

**Outputs:** Code changes committed by the orchestrator from `git diff`. The Implementation node is created by the orchestrator, not the coder.

**Retry/Recovery:**
- 0-turn startup retry: 10s cooldown, then re-spawn
- Session resume on bounce 2+: resumes the previous Claude Code session via `--resume` with verifier feedback injected. Falls back to fresh session on failure.
- Resume session ID tracked via `last_coder_session_id` across bounce iterations

---

## Verifier

**Role:** Verifies coder implementations. Reads code, runs tests, checks correctness against task requirements. Outputs a structured verdict.

**Model:** opus

**Permissions:**
- `allowedTools`: `Read,Grep,Glob,Bash(cargo:*),Bash(cd:*),Bash(mycelica-cli:*),mcp__mycelica__*`
- Write/Edit implicitly blocked by not being in `allowedTools`

Read-only. Can run restricted bash commands (cargo, cd, mycelica-cli) but cannot modify code.

**MCP Access:**
- Read tools: all 16
- Write tools: `mycelica_create_edge`, `mycelica_create_node`

**Inputs:** Task file with "Implementation to Check" section containing the implementation node ID. Reads the coder's git diff and runs tests.

**Outputs:** Structured `<verdict>` JSON blocks in stdout. The orchestrator uses three-tier verdict detection:
1. **Graph edge:** Looks for `supports`/`contradicts` edges from verifier to implementation node
2. **Structured JSON:** Parses `<verdict>{"verdict": "supports|contradicts", ...}</verdict>` blocks
3. **Keyword scan:** Falls back to searching for pass/fail keywords in text

All three tiers create graph edges when a verdict is detected.

**Retry/Recovery:**
- Subprocess failure retry: if verifier process fails (non-zero exit), retries once after 10s cooldown
- No session resume (each run is independent)

---

## Summarizer

**Role:** Creates Summary and optional Lesson nodes in the knowledge graph after a verified run.

**Model:** sonnet

**Permissions:**
- `allowedTools`: `mcp__mycelica__*,Read,Grep`
- `disallowedTools`: `Edit,Write,Bash,Glob`

Read-only with MCP write access for creating graph nodes.

**MCP Access:**
- Read tools: all 16
- Write tools: `mycelica_create_edge`, `mycelica_create_node`, `mycelica_create_meta`, `mycelica_update_meta`

**Inputs:** Task file, outcome description (verified/escalated), task node ID, implementation node ID, bounce count.

**Outputs:** Summary node linked to task node via `summarizes` edge. Optional Lesson node with Situation/Mistake/Fix/Evidence structure (filtered by `is_lesson_quality()`).

**When Invoked:** After verifier passes, unless `--no-summarize` is set.

**Retry/Recovery:** None.

---

## Operator

**Role:** Most privileged agent. Full unrestricted access for manual operational tasks.

**Model:** opus | **Turns:** 80

**Permissions:** All tools allowed. Unrestricted bash. Full MCP access including `create_meta` and `update_meta`.

**Invocation:** `mycelica-cli spore agent operator "task"` (single-agent dispatch only, not part of pipeline).

No native agent file -- uses `docs/spore/agents/operator.md` template only.

---

## Pipeline Flow

```
Task --> Context Compilation --> Coder (bounce 0)
                                   |
                                   v
                                Verifier
                                   |
                    +--------------+--------------+
                    |                             |
                 supports                    contradicts
                    |                             |
                    v                             v
              Summarizer?                   Coder (bounce N)
              (if enabled)                  [session resume]
                    |                        [feedback injected]
                    v                             |
                  Done                            v
                                              Verifier
                                                  |
                                           (repeat up to
                                            max_bounces)
                                                  |
                                                  v
                                            Escalation node
```

**Bounce behavior:**
- Bounce 0: Fresh coder session with full task file
- Bounce 1: Fresh coder session with verifier feedback appended
- Bounce 2+: Session resume (`--resume`) with verifier feedback injected
- Max bounces (default 3): Escalation node created, run marked as escalated

---

## MCP Tools Reference

### Read Tools (all 16, available to all agents)

| Tool | Description |
|------|-------------|
| `mycelica_explore` | Browse graph neighborhoods |
| `mycelica_search` | Semantic search over all nodes |
| `mycelica_node_get` | Get node metadata by ID/prefix/title |
| `mycelica_read_content` | Read full node content |
| `mycelica_code_show` | View source code for code nodes |
| `mycelica_nav_folder` | Browse file/folder structure |
| `mycelica_nav_edges` | Navigate edges from a node |
| `mycelica_query_edges` | Query edges by type/agent/time |
| `mycelica_explain_edge` | Get detailed edge explanation |
| `mycelica_path_between` | Find shortest path between nodes |
| `mycelica_edges_for_context` | Get contextual edges for a node |
| `mycelica_context_for_task` | Compile full task context from graph |
| `mycelica_list_region` | List nodes in a graph region |
| `mycelica_check_freshness` | Check if node data is current |
| `mycelica_status` | MCP server status |
| `mycelica_db_stats` | Database statistics |

### Write Tools by MCP Role

| MCP Role | `create_edge` | `create_node` | `create_meta` | `update_meta` |
|----------|:---:|:---:|:---:|:---:|
| Coder | yes | yes | - | - |
| Verifier | yes | yes | - | - |
| Summarizer | yes | yes | yes | yes |
| Operator | yes | yes | yes | yes |

**Source:** `AgentRole::allowed_tools()` in `src-tauri/src/mcp.rs`
