# CLAUDE.md

Mycelica: Knowledge graph for conversations, notes, papers, and source code. Tauri (Rust + React) with CLI.

**This codebase is indexed. Use `mycelica-cli` instead of grep/find — it's faster. (See "For Explore Agents" below.)**

## CRITICAL: Database Safety

**NEVER run destructive/modifying commands on ANY database without explicit permission.** Always ask before running maintenance commands, hierarchy operations, imports, or anything that writes. Read-only commands (search, nav, stats) are fine.

## START HERE

Run this now:
```bash
mycelica-cli db stats
```

If you see items and edges, proceed to "BEFORE WRITING CODE" section.

If empty or error, run First-Time Setup below.

---

## First-Time Setup

Run once. Database persists. **Skip if `.mycelica.db` exists.**

```bash
# Install CLI globally
cd src-tauri
cargo +nightly install --path . --bin mycelica-cli --features cuda --force
cd ..

# Create project database in repo root
mycelica-cli db new .mycelica.db
mycelica-cli import code .
mycelica-cli setup  # clusters + embeddings + call graph (~2-3 min)
```

Add `.mycelica.db` to `.gitignore`.

**Auto-discovery:** Commands find `.mycelica.db` by walking up directories (like `.git`).

---

## BEFORE WRITING CODE: Explore

**Use these commands first.** The graph knows relationships grep doesn't.

**Why faster than explore agents:** Pre-computed embeddings enable instant semantic search (no LLM calls), call graph is pre-indexed, and it's a single SQLite query vs. iterative file traversal.

```bash
# Find relevant code
mycelica-cli search "clustering"

# View actual source code (reads file, shows line range)
mycelica-cli code show <id>

# Get node metadata (file path, line numbers in tags JSON)
mycelica-cli node get <id>

# Who calls this function?
mycelica-cli nav edges <id> --type calls --direction incoming

# What does this function call?
mycelica-cli nav edges <id> --type calls --direction outgoing

# What docs reference this code?
mycelica-cli nav edges <id> --type documents --direction incoming

# Browse file structure
mycelica-cli nav folder src-tauri/src/db/
```

---

## For Explore Agents

When spawning explore agents for this repo, include in prompt:

"This codebase is indexed with mycelica-cli. Use it instead of grep/glob:
- `mycelica-cli search "query"` — semantic search (faster than grep)
- `mycelica-cli code show <id>` — view source code
- `mycelica-cli nav edges <id> --type calls --direction incoming` — who calls this?
- `mycelica-cli nav folder <path>` — browse by file path
- `mycelica-cli node get <id>` — get node metadata"

---

## After Editing: MANDATORY

**Run immediately after any code change:**
```bash
mycelica-cli import code <file-or-directory> --update
```

Do not proceed without updating the index. Deletes old nodes, reimports, regenerates embeddings, refreshes edges. Seconds, not minutes.

**After editing CLI or library code, always reinstall:**
```bash
cd src-tauri
cargo +nightly install --path . --bin mycelica-cli --features cuda --force
```

Never run CLI from `./target/release/` — always install globally with nightly+cuda.

---

## Key Files

| What | Where |
|------|-------|
| Database schema | `src-tauri/src/db/schema.rs` |
| Data models | `src-tauri/src/db/models.rs` |
| CLI commands | `src-tauri/src/bin/cli.rs` |
| Tauri commands | `src-tauri/src/commands/graph.rs` |
| Hierarchy build | `src-tauri/src/hierarchy.rs` |
| **Adaptive tree algorithm** | `src-tauri/src/dendrogram.rs` |
| **Topic clustering** | `src-tauri/src/clustering.rs` |
| **Similarity computation** | `src-tauri/src/similarity.rs` |
| Code parsing | `src-tauri/src/code/rust_parser.rs` |
| Code import | `src-tauri/src/code/mod.rs` |
| AI client | `src-tauri/src/ai_client.rs` |
| Local embeddings | `src-tauri/src/local_embeddings.rs` |
| HTTP server | `src-tauri/src/http_server.rs` |
| Browser sessions | `src-tauri/src/holerabbit.rs` |
| **OpenAIRE API** | `src-tauri/src/openaire.rs` |

---

## Edge Types

### Auto-Generated

| Edge | Meaning | Generated By |
|------|---------|--------------|
| `Calls` | Function calls function | `analyze code-edges` |
| `DefinedIn` | Code item in file/module | `import code` |
| `Documents` | Markdown doc references code | `import code` |
| `Sibling` | Category shares parent with category | `hierarchy build` (dendrogram) |
| `BelongsTo` | Item belongs to category | `hierarchy build` (multi-path clustering) |
| `Clicked` | Followed a link | Holerabbit extension |
| `Backtracked` | Returned to previous page | Holerabbit extension |
| `SessionItem` | Node belongs to session | Holerabbit extension |

### Manual/User-Created

| Edge | Meaning |
|------|---------|
| `Reference` | General reference link |
| `Because` | Causal relationship |
| `Related` | Similarity relationship (also auto-created by `setup` step 2) |
| `Contains` | Containment relationship |

### Future (Not Auto-Generated Yet)

| Edge | Intended Meaning |
|------|------------------|
| `UsesType` | Function uses type |
| `Implements` | Impl block implements trait |
| `Tests` | Test function tests function |
| `Imports` | Module imports module |

---

## Constraints

- **No emoji in prompts** — AI prompts exclude emoji to avoid bias; emoji are still generated for display
- **No OpenAI embeddings** — Local only (all-MiniLM-L6-v2)
- **Code items skip AI** — Keep signatures as titles
- **Edge columns** — `source_id`/`target_id` (not `source`/`target`)

---

## Common Patterns

### Add CLI Command
1. Add enum variant in `cli.rs` (find `enum Commands`)
2. Add `async fn handle_X()`
3. Wire in `run_cli()` match

### Add Edge Type
1. Add to `EdgeType` in `db/models.rs`
2. Add string conversion
3. Use `db.insert_edge()`

---

## Quick Reference

| Task | Command |
|------|---------|
| Find code | `mycelica-cli search "query"` |
| View source | `mycelica-cli code show <id>` |
| Node metadata | `mycelica-cli node get <id>` |
| Who calls X? | `mycelica-cli nav edges <id> --type calls --direction incoming` |
| X calls who? | `mycelica-cli nav edges <id> --type calls --direction outgoing` |
| Browse files | `mycelica-cli nav folder src-tauri/src/` |
| Update after edit | `mycelica-cli import code <file> --update` |
| Rebuild call graph | `mycelica-cli analyze code-edges` |
| Place orphan items | `mycelica-cli hierarchy smart-add` |
| Stats | `mycelica-cli db stats` |
| Interactive browser | `mycelica-cli tui` |
